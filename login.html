<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MVP Palmeiras - Login</title>

    <!-- SECCIÓN DE ESTILOS (CSS) -->
    <style>
        :root {
            --color-bg: #ffffff;
            --color-text: #000000;
            --color-whitet: #fff;
            --color-gray-medium: #e0e0e0;
            --color-gray-dark: #666666;
            --color-error: #ff0000;
            --font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--color-bg);
            color: var(--color-text);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        /* Contenedor Principal */
        .app-container {
            width: 100%;
            max-width: 400px;
            padding: 2rem;
            border: 1px solid var(--color-gray-medium);
            border-radius: 4px;
            background-color: var(--color-bg);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        /* Títulos y Textos */
        h1 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 2rem;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--color-gray-dark);
        }

        /* Formularios e Inputs */
        .form-group {
            margin-bottom: 1.5rem;
        }

        input[type="email"],
        input[type="password"] {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--color-gray-medium);
            background-color: var(--color-whitet);
            font-family: var(--font-family);
            font-size: 1rem;
            color: var(--color-text);
            outline: none;
            transition: border-color 0.2s, background-color 0.2s;
        }

        input[type="email"]:focus,
        input[type="password"]:focus {
            border-color: var(--color-text);
            background-color: var(--color-bg);
        }

        /* Botones */
        .btn-primary {
            width: 100%;
            padding: 0.85rem;
            background-color: var(--color-text);
            color: var(--color-bg);
            border: none;
            font-size: 1rem;
            font-weight: 600;
            text-transform: uppercase;
            cursor: pointer;
            transition: background-color 0.2s, opacity 0.2s;
        }

        .btn-primary:hover {
            opacity: 0.8;
        }

        /* Feedback de Errores */
        .message-box {
            margin-bottom: 1rem;
            padding: 0.75rem;
            font-size: 0.85rem;
            border: 1px solid var(--color-error);
            color: var(--color-error);
            background-color: #fff0f0;
            text-align: center;
            display: none;
            /* Oculto por defecto */
        }

        /* Utilidades */
        .hidden {
            display: none !important;
        }
    </style>

        <script>
        const INIT_DB_KEY = 'mini_json_db_data';

        // Validar si existe la DB en localStorage, si no, crearla con los datos por defecto
        if (!localStorage.getItem(INIT_DB_KEY)) {
            const initialDB = {
                "mvp soccer": {
                    "usuarios": {
                        "columns": [
                            "id",
                            "nombre",
                            "email",
                            "password",
                            "estado",
                            "rol"
                        ],
                        "rows": [
                            {
                                "id": 1767592207489,
                                "nombre": "Administrador",
                                "email": "admin@email.com",
                                "password": "159753",
                                "estado": "activo",
                                "rol": "admin"
                            }
                        ]
                    },
                    "categorias": {
                        "columns": [
                            "id",
                            "nombre",
                            "years_target",
                            "profesor_id",
                            "estado"
                        ],
                        "rows": []
                    },
                    "jugadores": {
                        "columns": [
                            "id",
                            "nombre",
                            "apellidos",
                            "año",
                            "email",
                            "password",
                            "grupo_id",
                            "estado"
                        ],
                        "rows": []
                    },
                    "tutores": {
                        "columns": [
                            "id",
                            "nombre",
                            "telefono",
                            "email",
                            "password",
                            "id_jugador"
                        ],
                        "rows": []
                    },
                    "calendario": {
                        "columns": [
                            "id",
                            "fecha",
                            "hora",
                            "tipo",
                            "id_categoria",
                            "categoria_nombre",
                            "duracion",
                            "rival",
                            "tipo_partido",
                            "lugar",
                            "estado"
                        ],
                        "rows": []
                    },
                    "pagos": {
                        "columns": [
                            "id",
                            "id_jugador",
                            "fecha_pago",
                            "mes",
                            "anio",
                            "monto"
                        ],
                        "rows": []
                    },
                    "notificaciones": {
                        "columns": [
                            "id",
                            "id_jugador",
                            "id_tutor",
                            "tipo",
                            "motivo",
                            "fecha_envio",
                            "contacto"
                        ],
                        "rows": []
                    }
                }
            };
            localStorage.setItem(INIT_DB_KEY, JSON.stringify(initialDB));
            console.log("Base de datos inicializada por defecto.");
        }
    </script>

</head>

<body>

    <!-- SECCIÓN DE ESTRUCTURA (HTML) -->
    <main class="app-container">
        <header>
            <h1>MVP Palmeiras</h1>
        </header>

        <section id="login-view">
            <div id="login-message" class="message-box"></div>

            <form id="login-form">
                <div class="form-group">
                    <label for="email">Correo Electrónico</label>
                    <input type="email" id="email" name="email" placeholder="admin@email.com" required>
                </div>

                <div class="form-group">
                    <label for="password">Contraseña</label>
                    <input type="password" id="password" name="password" placeholder="********" required>
                </div>

                <button type="submit" class="btn-primary">Ingresar</button>
            </form>
        </section>

        <section id="dashboard-view" class="hidden">
            <h2>Bienvenido</h2>
            <p id="user-name-display"></p>
            <br>
            <button id="logout-btn" class="btn-primary">Cerrar Sesión</button>
        </section>
    </main>

    <!-- SECCIÓN DE LÓGICA (JS) -->
    <script>
        const DB_KEY = 'mini_json_db_data';
        const SESSION_KEY = 'mini_json_session_data';

        /**
         * CLASE DE GESTIÓN DE BASE DE DATOS
         */
        class DBService {
            getData() {
                const data = localStorage.getItem(DB_KEY);
                return data ? JSON.parse(data) : null;
            }
        }

        /**
         * CLASE DE LOGIN CONTROLLER
         */
        // --- CONTROLADOR DE LOGIN (ACTUALIZADO Y CORREGIDO) ---
        class LoginController {
            constructor() {
                this.db = new DBService();
                this.loginForm = document.getElementById('login-form');
                this.messageBox = document.getElementById('login-message');

                this.initEvents();
            }

            initEvents() {
                this.loginForm.addEventListener('submit', (e) => this.handleLogin(e));
            }

            // Método para Mostrar Mensajes
            showMessage(msg, isError = true) {
                this.messageBox.textContent = msg;
                this.messageBox.style.display = 'block';
                this.messageBox.style.color = isError ? 'var(--color-error)' : 'green';
                this.messageBox.style.borderColor = isError ? 'var(--color-error)' : 'green';
                this.messageBox.style.backgroundColor = isError ? '#fff0f0' : '#f0fff0';
            }

            // --- MÉTODO FALTANTE: Ocultar Mensajes ---
            hideMessage() {
                this.messageBox.style.display = 'none';
            }

            handleLogin(e) {
                e.preventDefault();
                this.hideMessage(); // Llamada al método corregido

                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                const db = this.db.getData();

                if (!db || !db['mvp soccer']) {
                    this.showMessage('Error de estructura en base de datos.');
                    return;
                }

                // 1. Unificar todas las filas (Usuarios, Jugadores, Tutores)
                const allRows = [];
                if (db['mvp soccer'].usuarios && db['mvp soccer'].usuarios.rows) allRows.push(...db['mvp soccer'].usuarios.rows);
                if (db['mvp soccer'].jugadores && db['mvp soccer'].jugadores.rows) allRows.push(...db['mvp soccer'].jugadores.rows);
                if (db['mvp soccer'].tutores && db['mvp soccer'].tutores.rows) allRows.push(...db['mvp soccer'].tutores.rows);

                // 2. Buscar usuario por email
                const user = allRows.find(u => u.email === email);

                if (user) {
                    // 3. Validar Contraseña
                    if (user.password === password) {

                        // 4. Determinar el Rol
                        let rol = 'unknown';
                        let nombre = user.nombre;

                        if (user.rol) {
                            rol = user.rol;
                        } else if (db['mvp soccer'].jugadores && db['mvp soccer'].jugadores.rows.includes(user)) {
                            rol = 'jugador';
                        } else if (db['mvp soccer'].tutores && db['mvp soccer'].tutores.rows.includes(user)) {
                            rol = 'tutor';
                        }

                        // Validar estado
                        if (user.estado === 'inactivo') {
                            this.showMessage('El usuario está inactivo.');
                            return;
                        }

                        // 5. Crear Sesión
                        const sessionData = {
                            id: user.id,
                            nombre: nombre,
                            email: user.email,
                            rol: rol
                        };
                        localStorage.setItem(SESSION_KEY, JSON.stringify(sessionData));

                        // 6. Redirección
                        let destination = 'dashboard.html';
                        switch (rol.toLowerCase()) {
                            case 'admin': destination = 'dashboard.html'; break;
                            case 'profesor': destination = 'dashboard_profesor.html'; break;
                            case 'tutor': destination = 'dashboard_tutor.html'; break;
                            case 'jugador': destination = 'dashboard_jugador.html'; break;
                            default: destination = 'dashboard.html';
                        }

                        window.location.href = destination;

                    } else {
                        this.showMessage('Credenciales incorrectas.');
                    }
                } else {
                    this.showMessage('Credenciales incorrectas.');
                }
            }
        }
        document.addEventListener('DOMContentLoaded', () => {
            new LoginController();
        });
    </script>
</body>

</html>